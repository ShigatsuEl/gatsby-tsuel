---
title: Gatsby에 GraphQL과 Apollo를 사용해 타입 추가하기
date: 2021-07-06
slug: /blog/gatsby/graphql-apollo
---

# Gatsby에 GraphQL과 Apollo를 사용해 타입 추가하기

지금까지 우리는 TypeScript를 사용하기 위해 여러가지를 추가해왔습니다.

먼저 JavaScript에서 TypeScript로 확장하기 위해 Gatsby TypeScript Plugin을 추가하고 tsconfig를 설정했습니다.

그리고 더 나은 개발환경에서 작업하기 위해 Linter & Formatter 구성도 하였습니다.

하지만 이것만으로 Gatsby에서 TypeScript를 100% 활용한다고 하기에는 무리가 있습니다.

바로 설명을 시작하도록 하겠습니다.

## Gatsby는 어떻게 data를 받아오는가?

프로젝트에서 `Layout` 컴포넌트를 살펴보겠습니다.

`src/components/layout.tsx`
```tsx
const Layout = ({ children }: LayoutProps) => {
  const data = useStaticQuery(graphql`
    query {
      site {
        siteMetadata {
          title
        }
      }
    }
  `);

  return (
    <ThemeProvider theme={theme}>
      <GlobalStyle />
      <Header siteTitle={data.site.siteMetadata.title || `Title`} />
  ...
```

Layout 컴포넌트는 Gatsby에서 page를 만들 때 반드시 필요한 컴포넌트입니다.

`http://localhost:8000/`을 요청하면 home 라우트에 필요한 `src/pages/index` 컴포넌트를 가져와 사용하게 되는데

index 컴포넌트는 다시 Layout 컴포넌트에서 children으로 사용되고 있습니다.

`src/pages/index.tsx`
```tsx
const IndexPage = () => (
  <Layout>
    <Seo title="Home" />
    <h1>Hi people</h1>
    <p>Welcome to your new Gatsby site.</p>
    ...
  </Layout>
);
```

이처럼 Gatsby에서는 모든 page가 Layout 컴포넌트를 사용하게 되는데

Layout 컴포넌트를 자세히 살펴보면 Header 컴포넌트의 siteTitle prop에 `data.site.siteMetadata.title`을 넘겨주고 있습니다.

이쯤되면 이러한 생각이 들 수 있습니다.

>???
>>data.site.siteMetadata.title은 갑자기 어디서 튀어나오는 녀석이지?
>>진짜 Header의 값으로 data.site.siteMetadata.title이 적용되어 있는 것 일까?

확인해보기 위해 `gatsby deelop` 명령어로 서버를 시작하고 `http://localhost:8000`으로 요청하면 다음과 같은 Header를 볼 수 있습니다.

![Example](./example-09.PNG 'Gatsby siteTitle')

:scream::scream:

놀랍습니다!

`Gatsby Starter Library`라는 문구는 `data.site.siteMetadata.title`라는 값을 통해 얻어올 수 있었습니다.

그렇다면 data는 어디서 받아오는지 우리는 찾아내야만 합니다.

Layout 컴포넌트를 자세히 살펴보시면 위에

`src/components/layout.tsx`
```tsx
const data = useStaticQuery(graphql`
  query {
    site {
      siteMetadata {
        title
      }
    }
  }
`);
```

data의 값을 얻는 방법에 대해 알아볼 수 있습니다.

useStaticQuery 무슨 말인지 정확히는 몰라도 useStaticQuery 훅을 사용해 graphql로부터 data를 요청하고 있습니다.

신기하게 생각할 수도 있습니다.

그도 그럴게 우리는 어떠한 graphql 서버롤 직접 연결할 적이 없습니다.

하지만 Gatsby는 우리를 위해 미리 graphql 서버를 구성해두었습니다.

확인하고 싶으신가요? 다음 링크로 연결해봅시다.

:point_right: [localhost:8000/__graphql](http://localhost:8000/__graphql 'Gatsby GraphQL')

## Gatsby GraphiQL Server

아직 사용 방법을 모르신다고 해도 괜찮습니다! :blush:

가장 왼쪽 Explorer 탭은 여러분이 GraphQL이 가지고 있는 Schema를 눈으로 확인할 수 있습니다.

그리고 중간에 있는 탭은 query문을 직접 작성해 볼 수 있는 공간이며

마지막 오른쪽은 query 결과를 출력하여 우리 눈으로 확인할 수 있도록 도와줍니다.

우리가 해볼 작업은 다음과 같습니다.

1. Explorer 탭에서 site -> siteMetadata -> title 순으로 클릭한다.

2. Query가 클릭한 순으로 작성되어 있는지 확인한다.

3. GraphiQL 옆에 있는 Play 버튼을 클릭하여 결과를 확인하자.

![Example](./example-010.PNG 'Gatsby GraphiQL Result')

data.site.siteMetadata.title의 값을 찾았습니다!

그렇습니다. 우리는 Gatsby가 제공해주는 GraphiQL 서버로부터 data를 받아올 수 있었던 것 입니다.

하지만 data.site.siteMetadata.title 값을 제공한 적이 없는데 어떻게 이 값을 받아올 수 있는지 궁금해 하시는 분들이 계실수도 있습니다.

`gatsby-config.js` 파일을 열어보면 다음과 같이 세팅되어 있는 부분을 찾을 수 있습니다.

`gatsby-config.js`
```js
module.exports = {
  siteMetadata: {
    title: `Gatsby Default Starter`,
    description: `Kick off your next, great Gatsby project with this default starter. This barebones starter ships with the main Gatsby configuration files you might need.`,
    author: `@gatsbyjs`,
  },
}
```

Gatsby Default Starter Library를 사용하고 있다면 이미 제공되어 있는 siteMetadata값이 존재한다는 것을 확인해볼 수 있습니다.

>아하!
>>그렇다면 우리는 gatsby-*.js 값을 설정하면 GraphQL Server로부터 그 값을 받아오는 구조를 가지고 있구나.
>>잘만 이용하면 page별로 일일이 값을 설정하지 않고도 전역으로 사용할 데이터를 graphql로부터 받아오면 훨씬 편리할수도 있겠네.

:clap::clap::clap::clap:

이제 Gatsby가 GraphQL 기반으로 동작한다는 점을 이해하실 수 있습니다. :sunglasses:

하지만 한가지 문제점이 아직 남아 있습니다.

## GraphQL Schema Type

이 글의 맨 위에서 제시했던 문제점입니다.

이것만으로는 Gatsby에서 TypeScript를 100% 사용한다고 하기에는 무리가 있다는 것인데 과연 무엇이 부족한 것 일까요?

이제는 모두가 알다시피 Gatsby에서 data를 받아오기 위해 GraphQL을 사용합니다.

하지만 우리는 GraphQL로부터 받아오는 data의 Type까지는 받아올 수는 없다는 것 입니다. :sob:

따라서 Gatsby는 우리를 위해 GraphQL Type을 정의하는 법을 다음과 같이 제시합니다.

- :point_right: [Gatsby Create Type](https://www.gatsbyjs.com/docs/reference/graphql-data-layer/schema-customization/#creating-type-definitions 'Gatsby Create Type')

또는 Gatsby GraphQL Type을 생성하기 위해 관련된 플러그인을 사용할 수도 있습니다.

- :point_right: [Gatsby Typescript Graphql Codegen](https://www.gatsbyjs.com/plugins/gatsby-plugin-graphql-codegen/)

하지만 저는 위의 방법을 사용하지 않고 가장 원시적인 방식을 프로젝트에 적용시켜 보았습니다.

그 이유는 몇가지 있지만 가장 큰 이유는 VSCode에서 query를 작성할 때 auto complete가 적용되지 않는 점이 마음에 들지 않았습니다.

![Example](./example-01.png 'GraphQL No Auto Complete')

위와 같이 query를 작성할 때 자동으로 작성해주는 예시가 나타나지 않기 때문에 수동으로 직접 query를 작성해야 합니다.

이는 무엇을 graphql로부터 받아올 수 있는지 알 수 있는 방법이 없기 때문에 매우 불안정하게 query를 작성할 수 밖에 없습니다.

임시방편으로 해결할 수 있는 방법은 `http://localhost:8000/__graphql`을 들어가서 직접 query를 작성해서 결과를 확인하고

내 파일에 직접 copy & paste 하는 것 입니다.

하지만 이것은 굉장히 불편할 뿐만 아니라 타입을 통해 안정적으로 타이핑 해나가는 것과는 거리가 멀다고 할 수 있습니다.

저는 이것을 매우 귀찮다고 생각했기 때문에 좀 더 짱돌을 굴려보기로 결심했습니다. :smiling_imp:

