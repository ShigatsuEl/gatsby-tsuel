---
title: NestJS Refresh Token 활용하기
date: 2021-08-02
slug: /blog/project/mafia/security
categories: ['all', 'project']
tags: ['NestJS', 'TypeScript', 'Refresh-Token', 'Access-Token', 'XSS', 'CSRF']
---

[지난 글](/blog/project/mafia/login)에서 `Passport-Local` 전략을 구성해 사용자 이름 / 패스워드를 통한 로그인을 구현해 보았으며 JWT 인증 방식을 더해 로그인 후속조치를 
어떻게 할 것인지도 정했습니다. 한가지 아쉬운 점은 추후에 프론트 쪽에서 앱을 구성할 때, 로그인 상태임에도 불구하고 사이트를 종료하거나 새로고침을 
하게 되면 `accessToken` 정보가 전부 날아가므로 다시 로그인을 해야할 수도 있습니다. accessToken이 데이터베이스로부터 불러오는 것이 아니고 
로컬 데이터 변수로 저장되어 사용될 것이기 때문입니다.

이 문제를 해결하기 위한 방법을 찾기 위해 많은 구글링을 동원하였고 여러 개발자분들이 사용하는 몇가지 방법을 찾게 되었습니다.

1. localStorage 저장 방식

  localStorage는 브라우저가 가지고 있는 작은 저장소로 프론트의 데이터베이스 같은 역할을 합니다. 
  localStorage에 저장된 key / value 쌍은 영구적으로 저장이 된다는 장점이 존재하기 때문에 이곳에 `accessToken`을 저장한다면 
  위에서 언급한 문제(사이트 종료 또는 새로고침 시, accessToken이 날라가는 현상)를 해결할 수 있으므로 좋은 해결방안이 될 수 있습니다.

2. 쿠키 저장 방식

  JWT로 발급한 `accessToken`을 로그인을 통해 쿠키값으로 지정하는 방법입니다. 
  쿠키는 localStorage처럼 영구적으로 저장되지 않고 만료기간이 존재하며 만료기간을 지나면 더이상 사용할 수 없게 됩니다.

> 위 방법 중 어떤 방법이 더 좋을까? :confused:

위 질문의 정답을 도출하기 위해 여러 글을 찾아 읽고 내린 결론은 그 어떠한 방법도 완벽한 인증 방식이 될 수 없다는 것이었습니다. 
위의 두가지 방식의 공통적인 단점은 XSS공격에 대해 좋지 않은 방어태세를 가지고 있습니다. 
악성 클라이언트가 script를 사이트에 삽입하면 localStorage 저장소나 쿠키 저장소에 있는 값을 가져와 언제든지 인증된 사용자인 척 할 수 있기 
때문입니다. 이것은 사용자가 우리의 사이트를 신뢰하는 점을 이용한다고 볼 수 있습니다. 
두번째로 XSS공격으로 탈취한 정보를 기반으로 사이트로부터 인증받은 악성 클라이언트가 다른 인증된 사용자로부터 의도치 않은 행동을 유도하여 서버에 요청을 
보낼 수 있게하는 CSRF공격에 노출될 수 있다는 점 입니다. 
사용자가 사이트를 신뢰하는 점을 이용한 XSS공격에 반해 이것은 사이트가 사용자를 신뢰한다는 점을 이용한 것이라 할 수 있습니다. 
**이러한 이유로 localStorage 또는 쿠키에 accessToken을 저장하는 방식은 좋지 않을 수 있습니다.**

