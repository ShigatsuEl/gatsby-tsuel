---
title: NestJS Refresh Token 활용하기
date: 2021-08-02
slug: /blog/project/mafia/security
categories: ['all', 'project']
tags: ['NestJS', 'TypeScript', 'Refresh-Token', 'Access-Token', 'XSS', 'CSRF']
---

[지난 글](/blog/project/mafia/login)에서 `Passport-Local` 전략을 구성해 사용자 이름 / 패스워드를 통한 로그인을 구현해 보았으며 JWT 인증 방식을 더해 로그인 후속조치를 
어떻게 할 것인지도 정했습니다. 한가지 아쉬운 점은 추후에 프론트 쪽에서 앱을 구성할 때, 로그인 상태임에도 불구하고 사이트를 종료하거나 새로고침을 
하게 되면 `accessToken` 정보가 전부 날아가므로 다시 로그인을 해야할 수도 있습니다. accessToken이 데이터베이스로부터 불러오는 것이 아니고 
로컬 데이터 변수로 저장되어 사용될 것이기 때문입니다.

이 문제를 해결하기 위한 방법을 찾기 위해 많은 구글링을 동원하였고 여러 개발자분들이 사용하는 몇가지 방법을 찾게 되었습니다.

1. localStorage 저장 방식

  localStorage는 브라우저가 가지고 있는 작은 저장소로 프론트의 데이터베이스 같은 역할을 합니다. 
  localStorage에 저장된 key / value 쌍은 영구적으로 저장이 된다는 장점이 존재하기 때문에 이곳에 `accessToken`을 저장한다면 
  위에서 언급한 문제(사이트 종료 또는 새로고침 시, accessToken이 날라가는 현상)를 해결할 수 있으므로 좋은 해결방안이 될 수 있습니다.

2. 쿠키 저장 방식

  JWT로 발급한 `accessToken`을 로그인을 통해 쿠키값으로 지정하는 방법입니다. 
  쿠키는 localStorage처럼 영구적으로 저장되지 않고 만료기간이 존재하며 만료기간을 지나면 더이상 사용할 수 없게 됩니다.

> 위 방법 중 어떤 방법이 더 좋을까? :confused:

위 질문의 정답을 도출하기 위해 여러 글을 찾아 읽고 내린 결론은 그 어떠한 방법도 완벽한 인증 방식이 될 수 없다는 것이었습니다. 
위의 두가지 방식의 공통적인 단점은 XSS공격에 대해 좋지 않은 방어태세를 가지고 있습니다. 
악성 클라이언트가 script를 사이트에 삽입하면 localStorage 저장소나 쿠키 저장소에 있는 값을 가져와 언제든지 인증된 사용자인 척 할 수 있기 
때문입니다. 이것은 사용자가 우리의 사이트를 신뢰하는 점을 이용한다고 볼 수 있습니다. 
두번째로 악성 클라이언트가 다른 인증된 사용자로부터 의도치 않은 행동을 유도하여 서버에 요청을 보낼 수 있게하는 CSRF공격에 노출될 수 있다는 점 입니다. 
사용자가 사이트를 신뢰하는 점을 이용한 XSS공격에 반해 이것은 사이트가 사용자를 신뢰한다는 점을 이용한 것이라 할 수 있습니다. 
**이러한 이유로 localStorage 또는 쿠키에 accessToken을 저장하는 방식은 좋지 않을 수 있습니다.**

> 그렇다면 어떠한 방법을 사용해야 한단 말인가?? :sob:

먼저 accessToken을 가지고 인증을 구현했을 상황을 생각해봅시다.
accessToken의 인증 기간을 약 2주동안 설정하였고 해커가 accessToken을 탈취해갔다고 가정해보는 겁니다. 
여기서 생기는 가장 큰 문제는 해커가 accessToken을 가지고 서버에 어떠한 요청을 보내도 막을 방법이 없다는 것 입니다. 
그저 accessToken이 만료되는 기간(2주)동안 해커가 남용하는 상황을 지켜보고 있을 수 밖에 없습니다. 
accessToken의 단점 중 하나가 한번 생성되면 삭제할 수 있는 방법이 없기 때문입니다. 

그래서 accessToken이 탈취될 때를 대비해 accessToken의 만료기간을 굉장히 짧은 기간(5분)으로 설정하려고 합니다. 
짧은 기간이 주어졌기 때문에 설령 5분안에 accessToken을 탈취해간다고 해도 만료가 되는 시점에서 다시 accessToken을 발급 받아야 합니다. 
때문에 accessToken을 탈취 당한 가장 최악의 케이스에도 해커의 공격을 막을 수 있습니다. 
하지만 이번에도 문제가 생겼습니다. 
클라이언트 측에서 서비스를 이용하려고 로그인을 하였지만 인증을 진행한 5분뒤에 accessToken이 만료되어 다시 로그인을 진행해야 하는 상황이 
발생한 것 입니다. 
이는 사용자의 입장에서 별로 좋지 않은 경험을 제공하게 될 것 입니다.

이러한 문제점을 보완하기 위해 생겨난 개념이 refreshToken 입니다. 
refreshToken을 accessToken과 함께 사용하면 accessToken을 짧은 만료주기로 사용을 하면서도 로그인을 계속해서 유지시키는 것을 가능하게 할 수 있습니다. 
지금부터 우리는 accessToken과 함께 refreshToken을 발급받아 로그인을 연장시키도록 해보고 마지막으로 accessToken 단독사용 방법에 비해 어떠한 점이 
좋은지, 안좋은지를 따져보도록 할 것 입니다.

시작하겠습니다. :blush:
